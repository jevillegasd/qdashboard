<!DOCTYPE html>
<!--
QDashboard - Quantum Computing Dashboard
Built on flask-file-server foundation by Wildog: https://github.com/Wildog/flask-file-server
Extended with quantum computing specific features:
- Real-time QPU monitoring and package version tracking
- SLURM integration and job queue management
- Enhanced report rendering with Plotly support
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QDashboard - Quantum Computing Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{url_for('static', filename='css/dashboard.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/menu.css')}}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="d-flex" id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <div class="sidebar-heading">QDashboard</div>
            <div class="sidebar-nav">
                <div class="list-group list-group-flush">
                    <a href="/" class="list-group-item list-group-item-action active" id="nav-dashboard"><i class="fas fa-tachometer-alt"></i><span class="menu-text"> Dashboard</span></a>
                    <a href="/files" class="list-group-item list-group-item-action" id="nav-files"><i class="fas fa-folder"></i><span class="menu-text"> File Browser</span></a>
                    <a href="/latest" class="list-group-item list-group-item-action" id="nav-latest"><i class="fas fa-file-alt"></i><span class="menu-text"> Report Viewer</span></a>
                    <a href="/qpus" class="list-group-item list-group-item-action" id="nav-qpus"><i class="fas fa-microchip"></i><span class="menu-text"> QPU Status</span></a>
                    <a href="/experiments" class="list-group-item list-group-item-action" id="nav-experiments"><i class="fas fa-flask"></i><span class="menu-text"> Experiments</span></a>
                </div>
            </div>
            
            <!-- Package Versions Footer -->
            <div class="sidebar-footer-versions">
                <div class="version-title"><i class="fas fa-code"></i> Package Versions</div>
                {% for package, version in qibo_versions.items() %}
                    <div class="version-item">
                        <span class="version-name">{{ package.title() }}:</span>
                        {% if version == "Error" %}
                            <span class="version-error">Error</span>
                        {% elif version == "Not installed" %}
                            <span class="version-not-installed">Not installed</span>
                        {% else %}
                            <span class="version-number">{{ version }}</span>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <!-- <nav class="navbar navbar-expand-lg navbar-dark">
            PLACEHOLDER FOR A NAVIGATION BAR ONE DAY
            </nav> -->

            <div class="container-fluid">
                <h1 class="page-title">Dashboard</h1>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card text-white bg-ibm-blue mb-3">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-heartbeat"></i> QPU Health</h5>
                                <p class="card-text">{{ qpu_health }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <a href="/qpus" class="card-link">
                            <div class="card text-white bg-ibm-purple mb-3">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-microchip"></i> Available QPUs</h5>
                                    <p class="card-text">{{ available_qpus }}</p>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-tasks"></i> SLURM Queue
                                    <small class="text-muted ml-2" id="slurm-last-update"></small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" id="refresh-slurm-btn" title="Refresh SLURM data">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary ml-1" id="toggle-auto-refresh" title="Toggle auto-refresh mode">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body" id="slurm-content">
                                {% if slurm_queue_status %}
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Job ID</th>
                                                <th>Name</th>
                                                <th>User</th>
                                                <th>State</th>
                                                <th>Time</th>
                                                <th>Time Limit</th>
                                                <th>Nodes</th>
                                                <th>Node List</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for job in slurm_queue_status %}
                                            <tr>
                                                <td>{{ job.job_id }}</td>
                                                <td>{{ job.name }}</td>
                                                <td>{{ job.user }}</td>
                                                <td>
                                                    {% if job.state == 'RUNNING' %}
                                                        <span class="badge badge-success">{{ job.state }}</span>
                                                    {% elif job.state == 'PENDING' %}
                                                        <span class="badge badge-warning">{{ job.state }}</span>
                                                    {% elif job.state in ['COMPLETED', 'COMPLETING'] %}
                                                        <span class="badge badge-info">{{ job.state }}</span>
                                                    {% elif job.state in ['FAILED', 'CANCELLED', 'TIMEOUT'] %}
                                                        <span class="badge badge-danger">{{ job.state }}</span>
                                                    {% else %}
                                                        <span class="badge badge-secondary">{{ job.state }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ job.time }}</td>
                                                <td>{{ job.time_limit }}</td>
                                                <td>{{ job.nodes }}</td>
                                                <td>{{ job.nodelist }}</td>
                                                <td>
                                                    {% if job.is_current_user and job.state in ['RUNNING', 'PENDING'] %}
                                                        <button class="btn btn-sm btn-danger" 
                                                                onclick="cancelJob('{{ job.job_id }}')"
                                                                title="Cancel job">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    {% else %}
                                                        <span class="text-muted">—</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="text-center text-muted">
                                    <i class="fas fa-inbox fa-2x mb-2"></i>
                                    <p>No jobs in queue</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-file-code"></i> Last SLURM Log
                                    <small class="text-muted ml-2" id="slurm-log-last-update"></small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" id="refresh-log-btn" title="Refresh SLURM log">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <pre class="log-box" id="slurm-log-content"><code>{{ last_slurm_log | safe }}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /#page-content-wrapper -->

        
    </div>
    <!-- /#wrapper -->

    <!-- Footer -->
    <footer class="text-center text-muted py-3" style="font-size: 0.8rem; background-color: #1a1a1a;">
            <div class="container">
                TII QDashboard - Quantum Computing Dashboard built for the <a href="https://github.com/qiboteam/qibo">qibo</a> framework.
            </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
    // Job cancellation function
    function cancelJob(jobId) {
        if (!confirm(`Are you sure you want to cancel job ${jobId}?`)) {
            return;
        }

        fetch('/cancel_job', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                job_id: jobId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                // Refresh the page to update the job list
                location.reload();
            } else {
                alert(`Error: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while cancelling the job.');
        });
    }

    // SLURM refresh functionality
    function refreshSlurmData() {
        const refreshBtn = document.getElementById('refresh-slurm-btn');
        const slurmContent = document.getElementById('slurm-content');
        const isAutoMode = refreshBtn && refreshBtn.innerHTML.includes('Auto');
        
        // Only show loading state in manual mode
        if (!isAutoMode && refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            refreshBtn.disabled = true;
        }
        
        fetch('/api/slurm_status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update SLURM queue table
                updateSlurmTable(data.queue_status);
                // Update SLURM log
                updateSlurmLog(data.last_log);
                
                // Update timestamp indicator
                const timestamp = document.getElementById('slurm-last-update');
                if (timestamp) {
                    const now = new Date();
                    timestamp.textContent = `Last updated: ${now.toLocaleTimeString()}`;
                }
            } else {
                console.error('Error refreshing SLURM data:', data.message);
                if (!isAutoMode) {
                    alert('Failed to refresh SLURM data: ' + data.message);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (!isAutoMode) {
                alert('An error occurred while refreshing SLURM data.');
            }
        })
        .finally(() => {
            // Reset button state only in manual mode
            if (!isAutoMode && refreshBtn) {
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                refreshBtn.disabled = false;
            }
        });
    }

    function updateSlurmTable(jobs) {
        const slurmContent = document.getElementById('slurm-content');
        
        if (jobs.length === 0) {
            slurmContent.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p>No jobs in queue</p>
                </div>
            `;
        } else {
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Job ID</th>
                                <th>Name</th>
                                <th>User</th>
                                <th>State</th>
                                <th>Time</th>
                                <th>Time Limit</th>
                                <th>Nodes</th>
                                <th>Node List</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            jobs.forEach(job => {
                let stateBadge = '';
                if (job.state === 'RUNNING') {
                    stateBadge = `<span class="badge badge-success">${job.state}</span>`;
                } else if (job.state === 'PENDING') {
                    stateBadge = `<span class="badge badge-warning">${job.state}</span>`;
                } else if (['COMPLETED', 'COMPLETING'].includes(job.state)) {
                    stateBadge = `<span class="badge badge-info">${job.state}</span>`;
                } else if (['FAILED', 'CANCELLED', 'TIMEOUT'].includes(job.state)) {
                    stateBadge = `<span class="badge badge-danger">${job.state}</span>`;
                } else {
                    stateBadge = `<span class="badge badge-secondary">${job.state}</span>`;
                }
                
                let actionButton = '';
                if (job.is_current_user && ['RUNNING', 'PENDING'].includes(job.state)) {
                    actionButton = `
                        <button class="btn btn-sm btn-danger" 
                                onclick="cancelJob('${job.job_id}')"
                                title="Cancel job">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                } else {
                    actionButton = '<span class="text-muted">—</span>';
                }
                
                tableHtml += `
                    <tr>
                        <td>${job.job_id}</td>
                        <td>${job.name}</td>
                        <td>${job.user}</td>
                        <td>${stateBadge}</td>
                        <td>${job.time}</td>
                        <td>${job.time_limit}</td>
                        <td>${job.nodes}</td>
                        <td>${job.nodelist}</td>
                        <td>${actionButton}</td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            slurmContent.innerHTML = tableHtml;
        }
    }

    function updateSlurmLog(logContent) {
        const logElement = document.getElementById('slurm-log-content');
        if (logElement) {
            logElement.innerHTML = `<code>${logContent}</code>`;
        }
    }

    // Separate function to refresh only the log
    function refreshSlurmLog() {
        const refreshLogBtn = document.getElementById('refresh-log-btn');
        const isAutoMode = refreshLogBtn && refreshLogBtn.innerHTML.includes('Auto');
        
        // Only show loading state in manual mode
        if (!isAutoMode && refreshLogBtn) {
            refreshLogBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            refreshLogBtn.disabled = true;
        }
        
        fetch('/api/slurm_status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateSlurmLog(data.last_log);
                
                // Update timestamp indicator for log
                const logTimestamp = document.getElementById('slurm-log-last-update');
                if (logTimestamp) {
                    const now = new Date();
                    logTimestamp.textContent = `Last updated: ${now.toLocaleTimeString()}`;
                }
            } else {
                console.error('Error refreshing SLURM log:', data.message);
                if (!isAutoMode) {
                    alert('Failed to refresh SLURM log: ' + data.message);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (!isAutoMode) {
                alert('An error occurred while refreshing SLURM log.');
            }
        })
        .finally(() => {
            // Reset button state only in manual mode
            if (!isAutoMode && refreshLogBtn) {
                refreshLogBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                refreshLogBtn.disabled = false;
            }
        });
    }

    // Auto-refresh intervals
    let slurmDataInterval;
    let slurmLogInterval;
    let isAutoRefreshActive = false;
    
    // Function to start auto-refresh
    function startAutoRefresh() {
        if (isAutoRefreshActive) return;
        
        isAutoRefreshActive = true;
        
        // Refresh SLURM data every 2 seconds
        slurmDataInterval = setInterval(refreshSlurmData, 2000);
        // Refresh SLURM log every 2 seconds
        slurmLogInterval = setInterval(refreshSlurmLog, 2000);
        
        // Update toggle button
        const toggleBtn = document.getElementById('toggle-auto-refresh');
        if (toggleBtn) {
            toggleBtn.innerHTML = '<i class="fas fa-pause"></i>';
            toggleBtn.title = 'Stop auto-refresh (2s interval)';
            toggleBtn.classList.remove('btn-outline-secondary');
            toggleBtn.classList.add('btn-outline-warning');
        }
        
        // Update refresh button text to indicate auto-refresh is active
        const refreshBtn = document.getElementById('refresh-slurm-btn');
        const refreshLogBtn = document.getElementById('refresh-log-btn');
        
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Auto (2s)';
            refreshBtn.title = 'Auto-refresh active (2s interval)';
        }
        
        if (refreshLogBtn) {
            refreshLogBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Auto (2s)';
            refreshLogBtn.title = 'Auto-refresh active (2s interval)';
        }
    }
    
    // Function to stop auto-refresh
    function stopAutoRefresh() {
        if (!isAutoRefreshActive) return;
        
        isAutoRefreshActive = false;
        
        clearInterval(slurmDataInterval);
        clearInterval(slurmLogInterval);
        
        // Update toggle button
        const toggleBtn = document.getElementById('toggle-auto-refresh');
        if (toggleBtn) {
            toggleBtn.innerHTML = '<i class="fas fa-play"></i>';
            toggleBtn.title = 'Start auto-refresh (2s interval)';
            toggleBtn.classList.remove('btn-outline-warning');
            toggleBtn.classList.add('btn-outline-secondary');
        }
        
        // Reset refresh button text to manual mode
        const refreshBtn = document.getElementById('refresh-slurm-btn');
        const refreshLogBtn = document.getElementById('refresh-log-btn');
        
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            refreshBtn.title = 'Click to refresh manually';
        }
        
        if (refreshLogBtn) {
            refreshLogBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            refreshLogBtn.title = 'Click to refresh manually';
        }
    }
    
    // Toggle auto-refresh function
    function toggleAutoRefresh() {
        if (isAutoRefreshActive) {
            stopAutoRefresh();
        } else {
            startAutoRefresh();
        }
    }

    // Add event listener for refresh buttons and toggle
    document.addEventListener('DOMContentLoaded', function() {
        const refreshBtn = document.getElementById('refresh-slurm-btn');
        const refreshLogBtn = document.getElementById('refresh-log-btn');
        const toggleBtn = document.getElementById('toggle-auto-refresh');
        
        if (refreshBtn) {
            refreshBtn.addEventListener('click', refreshSlurmData);
        }
        
        if (refreshLogBtn) {
            refreshLogBtn.addEventListener('click', refreshSlurmLog);
        }
        
        if (toggleBtn) {
            toggleBtn.addEventListener('click', toggleAutoRefresh);
        }
        
        // Start auto-refresh immediately when page loads
        startAutoRefresh();
    });
    </script>
</body>
</html>
